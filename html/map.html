<!DOCTYPE html>
<html class="theme-dark">
    <head>
        <meta charset="UTF-8"/>
	    <meta name="description" content="Copyright (c) 2021, 2022 jmc - F4JDN. All rights reserved."/>

        <title>HBJSON Monitor</title>
        <link rel="shortcut icon" href="HBlink.png"/>

        <link rel="stylesheet" href="theme_template.css"/>
        <link rel="stylesheet" href="mysite_template.css"/>        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="crossorigin=""/>
        <script type="application/javascript" src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="crossorigin=""></script>
        <script type="application/javascript" src=" https://unpkg.com/@joergdietrich/leaflet.terminator@1.0.0/L.Terminator.js"></script>
    </head>

	<body>
        <center>
            <noscript>You must enable JavaScript</noscript>

            <div id="siteHeader">
                <div id="sitelogo">
                    <<<site_logo>>>
                </div>
                <div id="buttonArea">
                    <<<button_bar>>>
                </div>
                <br/>

                <!-- The Modal -->
                <div id="listenersModal" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <table class="tables tablefixed">
                            <thead id="theadListeners" tbodyid="listeners">
                                <tr class="headerRow">
                                    <th class="thlscallsign">Callsign</th>
                                    <th class="thlsip">IP</th>
                                    <th class="thlsport">Port</th>
                                    <th class="thlsnetid">NetID</th>
                                    </tr>
                            </thead>
                            <tbody id="listeners">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div name="hbtables">
                    <div id="insertPoint">
                        <div id="lastcallercontainer"style="text-align: left;">
                            <div id="callerinfo"></div>
                        </div>
                        <div id="legendcontainer"style="text-align: left;">
                            <div id="legendinfo">
                                <div>TG38<div style="background-color: #569cd6" class="legendIndicator"></div></div>
                                <div>TG39<div style="background-color: #a3e978" class="legendIndicator"></div></div>
                                <div>TG7<div style="background-color: #fca33c" class="legendIndicator"></div></div>
                                <div>TG777<div style="background-color: #bc7ebb" class="legendIndicator"></div></div>
                                <div>TX<div style="background-color: #fbd379" class="legendIndicator"></div></div>
                                <div>IND<div style="background-color: #fefefe" class="legendIndicator"></div></div>
                                <div>SWL<div id="btnlisteners" class="legendIndicator">0</div></div>
                            </div>
                        </div>
                        <div id="mapfrance">
                            <div id="map" class="tabContent" style="display: block;"><div id="mapid" style="height: 1000px;"></div>
                        </div>
                    </div>
                </div>
            
                <div id="footer">
                    <span>Copyright (c) 2021, 2022 <a href=https://github.com/avrahqedivra/HBJson>jmc - F4JDN</a></span>
                </div>
                <!--THIS COPYRIGHT NOTICE MUST BE DISPLAYED AS A CONDITION OF THE LICENCE GRANT FOR THIS SOFTWARE. ALL DERIVATEIVES WORKS MUST CARRY THIS NOTICE -->
            </div>                
        </center>
    </body>

    <style>
        #insertPoint {
            background-color: #202020;
        }

        .map {
            margin-top: 1rem;
        }
        
        .department {
            fill:   #2e2e2e;
            stroke: #505050;
            stroke-width: .5px;
        }

        #lastcallercontainer {
            display: none;
        }

        #callerinfo {
            display: hidden;
            margin: 4rem 0 0 4rem;
            position: absolute;
            color: white;
            text-align: left;
            padding: 0.5rem;
            background-color: rgba(78, 78, 78, 0.6);
            border-radius: 8px;
            z-index: 650;
        }

        #legendinfo {
            width: 6rem;
            margin: 4rem 0rem 4rem 72rem;
            position: absolute;
            color: white;
            text-align: left;
            padding: 0.5rem;
            background-color: rgba(78, 78, 78, 0.6);
            border-radius: 8px;
            z-index: 650;
        }

        .legendIndicator {
            float: right;
            width: 1.0rem;
            height: 1.0rem;
            color: var(--color-fg-marquee);
            background-color: var(--color-page);
            display: inline-block;
            margin-left: 1rem;
            text-align: center;
            cursor: default;
        }

        .leaflet-tooltip-left:before {
            right: 0;
            margin-right: -12px;
            border-left-color: #4e4e4e;
        }
        
        .leaflet-tooltip-right:before {
            left: 0;
            margin-left: -12px;
            border-right-color: #4e4e4e;
        }        

        .leaflet-tooltip-own {
            position: absolute;
            padding: 4px;
            text-align: left;
            background-color: #4e4e4e;
            border: 0;
            color: #ffffff;
            white-space: nowrap;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
            border-radius: 8px;
        }
        .svgicon {
            height: 1.4rem;
            filter: brightness(118%) contrast(119%);
            stroke: white;
        }
    </style>

    <script type="application/javascript">
        $(document).ready(function() {
            $(window).click(function(e) {
                if (event.target == document.getElementById("listenersModal"))
                    $("#listenersModal").hide();
            });        

            $(document).on("click", ".close", function() {
                $("#listenersModal").hide();
            });

            $(document).on("dblclick", "#btnlisteners", function(e) {
                if (e.ctrlKey) {
                    $("#listeners tr").remove();
                    var content = "";

                    listenerList = uniqByKeepLast(listenerList, swl => swl.NETID);

                    listenerList.forEach(swl => {
                        content += "<tr class='trlisteners'><td>" + swl.CALLSIGN + "</td><td>" + swl.IP + "</td><td>" + swl.PORT + "</td><td>" + swl.NETID + "</td></tr>";
                    });

                    $("#listeners").append(content);
                    $("#listenersModal").show();
                }
            });
        });
    </script> 

    <!-- 
        france, dom, belgique, suisse geojson 
    -->
    <script type="application/javascript" src="mapssvg.js"></script>

    <script type="application/javascript">
        // see names list in localstorage
        function enhanceNames(name) {
            if (names != null && names[name] != null)
                return names[name];

            return name;            
        }

        function displayLastCaller() {
            if (lastCaller != null) {
                html =  "Dernier appel de : <br/><br/>"
                        + "Indicatif : " + lastCaller.packet.CALLSIGN + " - TG" + lastCaller.packet.TGID + "<br/>"
                        + "Prénom : " + enhanceNames(lastCaller.packet.NAME) + "<br/>"
                        + "En ligne à : " + lastCaller.packet.TIME + " le " + lastCaller.packet.DATE + "<br/>";

                html += ((lastCaller.user != null && lastCaller.user.CITY != "") ? ("Ville : " + lastCaller.user.CITY + "<br/>") : "");
                html += ((lastCaller.user != null && lastCaller.user.COUNTRY.toLowerCase() == "france") ? ("Département : " + lastCaller.dept + "<br/>") : "");

                $('#callerinfo').empty().append(html);
                $('#lastcallercontainer').show();
            } 
            else
                $('#lastcallercontainer').hide();
        }

        function dealWithMap(packets) {
            var promises = [];

            // promises.push(departementsjson);
            promises.push(packets);
                
            Promise.all(promises).then((values) => {
                var html = null;
                var foundStartPacket = false;                
                const transmissions = values[0];

                transmissions.forEach((packet) => {
                    var dept = "0";
                    var country = "France";

                    var user = getUser(packet.DMRID.substr(0, 7));

                    if (packet.CALLSIGN.startsWith("FRS")) { // case FRSxxxx
                        if (user != null) {
                            if ((dept = parseInt(user.STATE)) < 10)
                                dept = "0"+dept;                                
                        }
                    } else {
                        if (packet.CALLSIGN.startsWith("FS") || packet.CALLSIGN.startsWith("FR") || packet.CALLSIGN.startsWith("HS") || packet.CALLSIGN.startsWith("BS") || packet.CALLSIGN.startsWith("FI")) { // best case FSxxxx
                            dept = packet.CALLSIGN.substring(2, 4);
                            if (dept == "97") { // treat 971 to 97x
                                if ((user != null) && user.STATE.toString().startsWith("97")) {                                
                                    if ((dept = parseInt(user.STATE)) < 10)
                                        dept = "0"+dept;
                                    
                                    country = user.COUNTRY;
                                }
                            } else {
                                if (dept == "99") {
                                    if ((user != null) && user.STATE.trim() != "") {
                                        country = user.COUNTRY;
                                        dept = user.STATE;
                                    }
                                }
                            }
                        } 
                        else {                        
                            // HAMs
                            // sock.send(JSON.stringify({"request": "user", "callsign": packet.CALLSIGN }));
                        }
                    }

                    if (packet.PACKET == "START") {
                        // set START backbground color
                        bgcolor = "#fbd379";

                        lastCaller = { "user": user, "dept": dept, "packet": packet, "timeout": Date.now() };
                        foundStartPacket = true;
                    }
                    else {
                        switch(packet.TGID) {
                            // set END backbground color
                            case   "7": bgcolor = "#fca33c"; break;
                            case  "38": bgcolor = "#569cd6"; break;
                            case  "39": bgcolor = "#a3e978" /*"#9fd87c"*/; break;
                            case "777": bgcolor = "#bc7ebb"; break;
                            default:    bgcolor = "#569cd6"; break;
                        }

                        if (!foundStartPacket)
                            lastCaller = { "user": user, "dept": dept, "country": country, "packet": packet, "timeout": Date.now() };
                    }

                    hiliteMap(dept, country, packet, user, bgcolor);
                });

                displayLastCaller();
            });
        }

        var geojson = null;
        var map = null;
        var lastcallerPanel = null;

        function log(msg) {
            console.log(msg);
        };

        function getUser(id) {
            if (subscribers != null) {
                for(let i=0; i < subscribers.length; i++) {
                    subscriber = subscribers[i];
                    if (subscriber.ID == id)
                        return subscriber;
                }
            }
            return null;
        }

        function uniqByKeepLast(a, key) {
            return [
                ...new Map(
                    a.map(x => [key(x), x])
                ).values()
            ]
        }

        function doUser(user) {
        }

        function doTraffic(t) {
            if (t != null)  {
                if (Array.isArray(t))
                    traffic = t;
                else {
                    // remove any previous "START" packet
                    for(let i=0; i < traffic.length; i++)
                        traffic[i].PACKET = "END";

                    traffic.push(t);
                }

                // sort in reverse order
                traffic.sort((a, b) => {
                    if (a.DATE > b.DATE) return 1;
                    if (a.DATE < b.DATE) return -1;

                    if (a.TIME > b.TIME) return 1;
                    if (a.TIME < b.TIME) return -1;
                });

                // keep the last N packets from traffic
                // traffic = uniqByKeepLast(traffic, it => it.DMRID);

                // deal with END packets
                dealWithMap(traffic);

                // treat START one
                if (!Array.isArray(t) && t.PACKET == "START") {
                    dealWithMap([t]);
                }
            }
        }
/*
        function sendMessage(sock, callsign) {
            return new Promise((resolve, reject) => {
                sock.send( JSON.stringify({"request": "user", "callsign": callsign }));

                sock.onmessage = (e) => {
                    resolve(JSON.parse(e.data));
                };
                sock.onerror = (err) => {
                    reject(err);
                };

            });
        }
*/
        // https://mdbootstrap.com/snippets/jquery/ascensus/531046#js-tab-view
        // https://www.datavis.fr/index.php?page=map-population
        // https://colorbrewer2.org/#
        // https://www.wrld3d.com/wrld.js/latest/docs/leaflet/L.Path/#path-option
        // https://github.com/mathiasleroy/Belgium-Geographic-Data
        // https://gist.github.com/BrendonKoz/b1df234fe3ee388b402cd8e98f7eedbd
        // https://github.com/yigityuce/Leaflet.Control.Custom
        // https://www.2c2r.fr/wp-content/plugins/edservices_common/france-geojson/
        // https://github.com/joergdietrich/Leaflet.Terminator

        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle( { "fillColor": "#569cd6" } );
        }        

        function resetHighlight(e) {
            var layer = e.target;
            layer.setStyle( { "fillColor": "black", "fillOpacity":  0.3 } );
        }        

        function hiliteMap(dept, country, packet, user, bgcolor) {
            Object.keys(geojson._layers).forEach(function(key) {
                layer = geojson._layers[key];
                feature = layer.feature;

                if (country == "Espagne")
                    dept = "ES"+dept;

                if (feature.properties.code == dept) {
                    var code = ""+feature.properties.code;
                    
                    if (code.startsWith("ES"))
                        code = code.substr(2);

                    opacity = (country == "France") ? 0.6 : 0.8;

                    layer.setStyle({ 'fillColor': bgcolor, "fillOpacity":  opacity, "color": "#002000" });

                    html = "<div style='padding:1px 3px 1px 3px'>Callsign : " + packet.CALLSIGN + "<br/>"
                        + "Prénom : " + enhanceNames(packet.NAME) + "<br/>"
                        + "En ligne à : " + packet.TIME + " le " + packet.DATE + "<br/>";

                    html += ((user != null && user.CITY != "") ? ("Ville : " + user.CITY + "<br/>") : "")
                        + "Département : " + feature.properties.nom + " (" + code + ")<br/>";

                    layer.bindTooltip(html, {
                            direction: 'right',
                            permanent: false,
                            sticky: true,
                            offset: [20, 0],
                            opacity: 0.75,
                            className: 'leaflet-tooltip-own' 
                    });
                }
            });
        }

        function initMap() {
            map = L.map('map', 
                {   
                    zoomDelta: 0.25,
                    zoomSnap: 0,
                    minZoom: 3,
                    maxZoom: 10 }).setView([47.0781336, 2.3282644], currentZoom);

            L.control.scale().addTo(map);

            // var osm = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
	        //     attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
            //     className: 'map-tiles'
            // }).addTo(map);

            // var osm = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
	        //     attribution: '&copy; OpenStreetMap France | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            //     className: 'map-tiles'
            // }).addTo(map);

            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                className: 'map-tiles'
            }).addTo(map);

            // night and day layer
            var terminator = L.terminator();
            terminator.setStyle({ "fillOpacity":  0.2 });
            terminator.addTo(map);
            
            // night layer refresh timer
            setInterval(() => {
                terminator.setTime();
            }, 5000);

            geojson = L.geoJson(frbesw, {
                style : function(feature) {
                    return {    
                        "stroke":               true,
                        "color":                "#004000",
                        "weight":               1,
                        "opacity":              0.20,
                        "fill":                 true,       // to display tooltips
                        "fillOpacity":          "var(--normal-fillopacity)",
                        "fillColor":            "var(--normal-fillcolor)"
                    }
                },
                onEachFeature : function (feature, layer) {                    
                    layer._leaflet_id = feature.properties.nom;

                    layer.on({
                        // mouseover: highlightFeature,
                        // mouseout: resetTooltip
                    });

                    var code = ""+feature.properties.code;
                    
                    if (code.startsWith("ES"))
                        code = code.substr(2);

                    layer.bindTooltip("<div style='padding:1px 3px 1px 3px'>" + "Département : " + code + "<br/>Région : " + feature.properties.nom + "</div>", 
                    {
                        direction: 'right',
                        permanent: false,
                        sticky: true,
                        offset: [20, 0],
                        opacity: 0.75,
                        className: 'leaflet-tooltip-own' 
                    });
                }
            });

            map.on('zoomend', function () {
                currentZoom = map.getZoom();

                // console.log("weight : " + Math.round(currentZoom / 2.5));
                
                if (currentZoom > 8)
                    geojson.setStyle({ weight: Math.round(currentZoom / 2.5) });
                else
                    geojson.setStyle({ weight: 1 });
            });

            map.addLayer(geojson);
        }

        window.onload = () => {
            listeners = 0;
            traffic = [];
            listenerList = [];            
            currentZoom = 6.5;
            subscribers = null;
            departments = [];            
            lastCaller = null;
            tgfilter = new Set("<<<TGID_FILTER>>>".split(','));

            getConfigFromLocalStorage();

            var wsuri = "ws://" + window.location.hostname + ":<<<SOCKET_SERVER_PORT>>>?page=map";

            initMap();

            function WSConnection() {
                'use strict';
                this.socket = {};
            }

            WSConnection.prototype.connect = (url) => {
                'use strict';

                return new Promise((resolve, reject) => {
                    if ("WebSocket" in window)
                        this.socket = new WebSocket(url);
                    else if ("MozWebSocket" in window)
                        this.socket = new MozWebSocket(url);
                    else {
                        log("Browser does not support WebSocket!");
                        resolve();
                    }

                    this.socket.onopen = () => {
                        log("Connected to " + url)
                        resolve();
                    };

                    this.socket.onmessage = (e) => {
                        var data = null;

                        // clears lastCaller after N minutes
                        if ((lastCaller != null) && (Date.now() - lastCaller.timeout > 3 * 60 * 1000)) { // 3 min
                            $('#lastcallercontainer').hide();
                            lastCaller = null;
                        }

                        try {
                            if (themeSettings == "auto")
                                adjustTheme();

                            if ((data = JSON.parse(e.data)) != null) {
                                // console.log("");
                                // console.log(data);
                                // console.log("");
                                if (data.BIGEARS)
                                    $("#btnlisteners").text(data.BIGEARS);

                                if (data.LISTENERS)
                                    listenerList = data.LISTENERS;

                                if (data.TRAFFIC)
                                    doTraffic(data.TRAFFIC);                                    
                                else
                                if (data.CONFIG) {
                                    if (data.CONFIG.BIGEARS)
                                        $("#btnlisteners").text(data.CONFIG.BIGEARS);

                                    if (data.CONFIG.USERS)
                                        subscribers = data.CONFIG.USERS;

                                    if (data.CONFIG.PACKETS)
                                        doTraffic(data.CONFIG.PACKETS.TRAFFIC);

                                    if (data.CONFIG.LISTENERS)
                                        listenerList = data.CONFIG.LISTENERS;
                                } 
                                else
                                if (data.USER)
                                    doUser();
                            }
                        } catch(error) {
                            log(error);
                        }
                    };

                    socket.onerror = function (error) {
                        console.log('WebSocket error: ' + error);
                        reject(error);
                    };

                    socket.onclose = function (e) {
                        log("Connection closed (wasClean = " + e.wasClean + ", code = " + e.code + ", reason = '" + e.reason + "')");
                        this.sock = null;
                    };
                });
            };

            WSConnection.prototype.disconnect = () => {
                'use strict';
                console.log("Disconnect request from local app layer");
                this.socket.close();
            };

            socket = new WSConnection().connect(wsuri);
        };

        window.onunload = () => {
            socket = null;
        }
</script>
</html>
