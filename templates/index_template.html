<!DOCTYPE html>
<html class="<<<THEME>>>" manifest="hbjson.appcache">

<head>
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<meta charset="UTF-8">
		<meta http-equiv="refresh" content="20000"/>
		<title>HBJSON Monitor</title>

    <link rel="stylesheet" href="theme_template.css">
    <link rel="stylesheet" href="mysite_template.css">
    <meta name="description" content="Copyright (c) 2016, 2017, 2018, 2019.The Regents of the K0USY Group. All rights reserved. Version SP2ONG 2019-2020 (v20200629)" />

		<style>
			/* #hbtables {
				margin-top: 0rem;
				height: calc(100vh - 16rem);
				overflow-y: scroll;
				width: fit-content;
				scrollbar-width: thin;
			} */
	
			#hbtables::-webkit-scrollbar {
				display: block;
				width: 6px;
				background-color: #404040;
			}
	
			#hbtables::-webkit-scrollbar-thumb {
				background-color: #569cd6;
			}
	
			.talkgroup canvas {
				position: absolute;
				top: 0.3rem;
				left: -0.15rem;
			}

			@supports (-moz-appearance:none) {
				div[name="hbtables"] { 
						overflow-y: scroll;
						width: fit-content;
						margin-top: 0.5rem;
						scrollbar-color: #569cd6 #404040;
				}
			}
		</style>
	</head>

<body>
	<center>
		<noscript>You must enable JavaScript</noscript>

		<div id="siteHeader">
			<div id="sitelogo"><<<site_logo>>></div>

			<div id="buttonArea"><<<button_bar>>><div class="button iconbutton" id="btnlisteners">&#x1F441; 0</div></div>

			<!-- The Modal -->
			<div id="statisticsModal" class="modal">
				<!-- Modal content -->
				<div class="modal-content-statistics">
					<span class="close close-statistics">&times;</span>
					<table class="tablefixed">
						<thead id="theadStatistics" tbodyid="statistics">
							<tr class="headerRow">
								<th class="thlstg">TG</th>
								<th class="thlsCnx">Nb Cnx</th>
								<th class="thlsDelay">Total Time</th>
							</tr>
						</thead>
						<tbody id="statistics">
						</tbody>
					</table>
				</div>
			</div>

			<!-- The Modal -->
			<div id="listenersModal" class="modal">
				<!-- Modal content -->
				<div class="modal-content-listeners">
					<span class="close close-listeners">&times;</span>
					<table class="tablefixed">
						<thead id="theadListeners" tbodyid="listeners">
							<tr class="headerRow">
								<th class="thlscallsign">Callsign</th>
								<th class="thlsip">IP</th>
								<th class="thlsport">Port</th>
								<th class="thlsnetid">NetID</th>
							</tr>
						</thead>
						<tbody id="listeners">
						</tbody>
					</table>
				</div>
			</div>

			<!-- The Modal -->
			<div id="followUpModal" class="modal">
				<!-- Modal content -->
				<div class="modal-content-followup">
					<span class="close close-followup">&times;</span>
					<table class="tablefixed">
						<thead id="theadFollowUp" tbodyid="followup">
							<tr class="headerRow">
								<th class="thlename">Name</th>
								<th class="thledate">Date</th>
								<th class="thletime">Time</th>
								<th class="thletg">TG</th>
								<th class="thlelog">LOG</th>
								<th class="thledelay">TX</th>
							</tr>
						</thead>
						<tbody id="followup">
						</tbody>
					</table>
				</div>
			</div>

			<!-- The Modal -->
			<div id="inputModal" class="modal">
				<!-- Modal content -->
				<div class="modal-content-input">
						<input type="search" id="search" name="search" placeholder="DMRID or CALLSIGN"><button type="button" onclick="followupdmrid()">Search</button>
				</div>
			</div>

			<div name="hbtables" id="hbtables">
				<table id="lastActive" class="tables lastActive tablefixed" style="display: none;">
					<thead>
						<tr class="headerRow">
							<th class="thledate">Date</th>
							<th class="thletime">Heure</th>
							<th class="thleslot">Slot</th>
							<th class="thletx" colspan=2>TX Connectés</th>
							<th class="thlename">Name</th>
							<th class="thletg">TGs</th>
							<th class="thlepc">%</th>
							<th class="thlelog"><a target="_self" href="loglast.html">LOG+ (Cliquez ICI)</a></th>
							<th class="thledelay">TX (s)</th>
							<th class="thlenetid">NetID</th>
							<th class="thlemaster">Master Infra</th>
						</tr>
					</thead>
					<tbody id="lastActiveBody"></tbody>
				</table>

				<div id="insertPoint"></div>
				<br>
				<div id="sysoptables">
					<table class="tables tablefixed network">
						<thead id="theadOpenbridges" tbodyid="openbridges">
							<tr class="headerRow">
								<th class="thopmaster">OpenBridge</th>
								<th class="thopnetid">ID Réseau(x)</th>
								<th class="thopcalls">Appel(s) Actif(s)</th>
							</tr>
						</thead>
						<tbody id="openbridges">
						</tbody>
					</table>
					<br>
					<table class="tables tablefixed network">
						<thead id="theadMasters" tbodyid="masters">
							<tr class="headerRow">
								<th class="thmsmaster">Master</th>
								<th class="thmsnetid">NetID</th>
								<th class="thmstime">Connecté(s)</th>
								<th class="thmsslot">Slot</th>
								<th class="thmstx">Poste(s) Connecté(s) TX</th>
								<th class="thmsdest">Conf. Destination</th>
							</tr>
						</thead>
						<tbody id="masters">
						</tbody>
					</table>
					<br>
					<table class="tables tablefixed network">
						<thead id="theadPeers" tbodyid="peers">
							<tr class="headerRow">
								<th class="thpemaster">Peer</th>
								<th class="thpenetid">NetID</th>
								<th class="thpetime">Connecté(s)</th>
								<th class="thpeslot">Slot</th>
								<th class="thpetx">Poste(s) Connecté(s) TX</th>
								<th class="thpedest">Conf. Destination</th>
							</tr>
						</thead>
						<tbody id="peers">
						</tbody>
					</table>
				</div>
			</div>

			<div id="footer">
				<div>Copyright (c) 2016-2020, The Regents of the <a href=http://k0usy.mystrikingly.com>K0USY Group. All rights reserved.</a> 
					<br><a href=https://github.com/sp2ong/HBmonitor>Modified by SP2ONG 2019, 2020</a>
					&nbsp;- Modified by NumeriX 2019, 2020 
					<br>JSON, MYSQL version by <a href=https://github.com/avrahqedivra/HBJson>jmc - F4JDN </a>2021, 2022.
				</div> 
			</div> 
			<!--THIS COPYRIGHT NOTICE MUST BE DISPLAYED AS A CONDITION OF THE LICENCE GRANT FOR THIS SOFTWARE. ALL DERIVATEIVES WORKS MUST CARRY THIS NOTICE -->
		</div>
	</center>
</body>

<script src="pureknob.js"></script>

<script type="text/javascript">
	var traffic = [];
	var sock = null;
	var displayLines = parseInt("<<<DISPLAY_LINES>>>");

	hideAllTG = false;
	listenerList = [];
	tgfilter = new Set("<<<TGID_FILTER>>>".split(','));
	tgorder = new Set("<<<TGID_ORDER>>>".split(','));
	tghilite = new Set("<<<TGID_HILITE>>>".split(','));
	dynamic_tg = ("<<<DYNAMIC_TG>>>" == "True") ? true : false;
	hide_dmrid = new Set("<<<HIDE_DMRID>>>".split(','));
	displayPercent = "<<<DISPLAY_PERCENT>>>" != "False"
	last_active_tg = ("<<<LAST_ACTIVE_TG>>>" == "True") ? true : false;

	try {
		tgbeacons = JSON.parse('<<<TGID_BEACONS>>>');
	} catch(e) {
		tgbeacons = {};
	}

	try {
		tgsettings = JSON.parse('<<<TGID_SETTINGS>>>');
		hide_dmrid = null;
	} catch(e) {
		tgsettings = {};
	}

	last_active_size = parseInt("<<<LAST_ACTIVE_SIZE>>>");
	if (last_active_size == 0)
		last_active_size = tgorder.size;

	//   https://stackoverflow.com/questions/9229645/remove-duplicate-values-from-js-array
	function uniqByKeepFirst(a, key) {
		let seen = new Set();
		return a.filter(item => {
			let k = key(item);
			return seen.has(k) ? false : seen.add(k);
		});
	}

	function uniqByKeepLast(a, key) {
		return [
			...new Map(
				a.map(x => [key(x), x])
			).values()
		]
	}

	function updateBridges(bridges) {
		if (bridges != null) {
			var content = "";

			// console.log(JSON.stringify(bridges));
		}
	}

	function updateOpenBridges(openBridges) {
		if (openBridges != null && $('#openbridges').is(':visible')) {
			$("#openbridges tr").remove();

			// console.log("");
			// console.log(JSON.stringify(openBridges));
			// console.log("");

			var content = "";

			for (let openBridge in openBridges) {
				record = openBridges[openBridge];
				content += "<tr><td class='obName'>" + openBridge + "</td><td class='obNetID'>NetID:&nbsp;" + record["NETWORK_ID"] + "</td>";

				var entry = "";
				var data = null;
				var streams = record["STREAMS"];

				if (Object.keys(streams)) {
					for (let streamId in streams) {
						if ((data = streams[streamId]) != null) {
							if (entry != "") entry += " ";
							entry += "( " + data[0] + " | " + data[1] + " >> " + data[2] + " )";
						}
					}
				}

				var cnx = ((data == null || data[0] == "") ? "msTS" : ((data[0] == "TX") ? "msTSRX" : "msTSTX"));

				content += "<td class='" + cnx + " ellipsis'>" + entry + "</td></tr>";
			}

			$("#openbridges").append(content);
		}
	}

	function updatePeers(peers) {
		if (peers != null && $('#peers').is(':visible')) {
			$("#peers tr").remove();

			//    console.log("");
			//    console.log(JSON.stringify(peers));
			//    console.log("");

			var content = "";

			for (let peer in peers) {
				var record = peers[peer];
				var r1trx = record["1"]["TXRX"];
				var r2trx = record["2"]["TXRX"];
				
				ts1 = (r1trx == "") ? "msTS1" : ((r1trx == "TX") ? "msTSTX" : "msTSRX");
				cnx1 = (r1trx == "") ? "msTS" : ((r1trx == "TX") ? "msTSTX" : "msTSRX");

				ts2 = (r2trx == "") ? "msTS2" : ((r2trx == "TX") ? "msTSTX" : "msTSRX");
				cnx2 = (r2trx == "") ? "msTS" : ((r2trx == "TX") ? "msTSTX" : "msTSRX");

				peState = record["STATS"]["CONNECTION"] == "YES" ? "peON" : "peOFF";

				content += "<tr><td class='msMasters' rowspan='3'>" + peer
					+ "<br><div class='msRepeat'>Mode:&nbsp;" + record["MODE"] + "</div></td></tr>"

					+ '<tr><td rowspan="2"><div class="tooltip"><div class="msCallsign">' + record["CALLSIGN"] + '</div>'
					+ '<span class="msNetID">&nbsp;(Id: ' + record["RADIO_ID"] + ')</span>'
					+ '<span class="tooltiptext"><span style="font: 9pt arial,sans-serif;color:#FFFFFF">'
					+ '&nbsp;&nbsp;&nbsp;<b><font color="yellow">Linked Time Slot:&nbsp;</font></b>' + record["SLOTS"]
					+ '</span></span></div><br><div class="msLocation">' + record["LOCATION"] + '</div></td>'

					+ '<td class="' + peState + '" rowspan="2">'
					+ record["STATS"]["CONNECTED"] 
					+ '<br><div style="font: 8pt arial, sans-serif">'
					+ record["STATS"]["PINGS_SENT"] 
					+ " / " + record["STATS"]["PINGS_ACKD"] 
					+ " / " + (record["STATS"]["PINGS_SENT"] - record["STATS"]["PINGS_ACKD"]) 
					+ "</div></td>"

					+ '<td class="' + ts1 + '">TS1</td>'
					+ '<td class="' + cnx1 + '">' + record["1"]["SUB"] + '</td>'
					+ '<td class="' + cnx1 + '">' + record["1"]["DEST"] + '</td>'
					+ '</tr>'

					+ '<tr><td class="' + ts2 + '">TS2</td>'
					+ '<td class="' + cnx2 + '">' + record["2"]["SUB"] + '</td>'
					+ '<td class="' + cnx2 + '">' + record["2"]["DEST"] + '</td></tr>';
			}

			$("#peers").append(content);
		}
	}

	// https://gist.github.com/umidjons/9614157
	function sortMastersPeersByOnlineTime(peers) {
		var peersArray = [];

		// convert to array
		for (var key in peers) {
			peersArray.push([key, peers[key]]);
		}

		// convert online time to seconds
		let len = peersArray.length;
		for (let i = 0; i < len; i++) {
			var t = peersArray[i]["1"]["CONNECTED"].split(" ");

			switch (t.length) {
				case 3:
					peersArray[i]["1"]["ONLINE"] = "" + (parseInt(t[0]) * 86400 + parseInt(t[1]) * 3600 + parseInt(t[2]));
					break;

				case 2:
					chr = t[0].slice(-1);
					if (chr == 'd')
						peersArray[i]["1"]["ONLINE"] = "" + (parseInt(t[0]) * 86400 + parseInt(t[1]) * 3600);
					else
					if (chr == 'h')
						peersArray[i]["1"]["ONLINE"] = "" + (parseInt(t[0]) * 3600 + parseInt(t[1]) * 60);
					else
					if (chr == 'm')
						peersArray[i]["1"]["ONLINE"] = "" + (parseInt(t[0]) * 60 + parseInt(t[1]));
					break;

				case 1:
					peersArray[i]["1"]["ONLINE"] = "" + parseInt(t[0]);
					break;

				default:
					peersArray[i]["1"]["ONLINE"] = "0";
					break;
			}
		}

		// sort peers array
		peersArray.sort((a, b) => {
			y = parseInt(a[1]["ONLINE"]);
			x = parseInt(b[1]["ONLINE"]);

			return x < y ? -1 : x > y ? 1 : 0;
		});

		return peersArray;
	}

	function getMasterFlag(src, str) {
		if (str == null || str == "")
			return "";

		var index = 0;

		switch(src) {
			case 0:
				if ((index = str.lastIndexOf("(")) != -1)
					str = ""+parseInt(str.substr(index+1));
				break;

			case 1:
				if ((index = str.indexOf("(")) != -1)
					str = str.substr(index+1, 3)
				break;
			
			case 2:
				if ((index = str.indexOf("(Id: ")) != -1)
						str = str.substr(index+5, 3)
					break;
		}

		return getTgFlag(str);
	}

	function updateMasters(masters, emaster) {
		if (masters != null && $('#masters').is(':visible')) {
				var content = "";
				$("#masters").empty();

				for (let entry in masters) {
						done = false;

						if (!done) {
								// skip empty peers
								var length = Object.keys(masters[entry]["PEERS"]).length;
								if (length == 0 && !emaster)
										continue;

								rowspan = Math.max(1, length) * 2 + 1;
								content += "<tr><td class='msMasters' rowspan='" + rowspan + "'>" + entry + "<br><div class='msRepeat'>" + masters[entry]["REPEAT"] + "</div></td></tr>";
								done = true;
						}

						var peers = sortMastersPeersByOnlineTime(masters[entry]["PEERS"]);
						var peersLength = peers.length;

						try {
							if (peersLength == 0) {
									content += '<tr>';
									+ '<td rowspan="2">'
									+ '<div class="tooltip">'
									+ '<div class="msCallsign">N/A</div>'
									+ '<span class="msNetID">&nbsp;(Id: n/a)</span>'
									+ '<span class="tooltiptext">'
									+ '<span style="font: 9pt arial,sans-serif;color:#FFFFFF">'
									+ '&nbsp;&nbsp;&nbsp;<b><font color="yellow">N/A</font></b><br>'
									+ '&nbsp;&nbsp;&nbsp;<b>Type/Slot</b>: ' + "N/A"
									+ '<br>&nbsp;&nbsp;&nbsp;<b>Soft_Ver</b>: ' + "N/A"
									+ '<br>&nbsp;&nbsp;&nbsp;<b>Hardware</b>: ' + "N/A"
									+ '</span>'
									+ '</span>'
									+ '</div>'
									+ '<br>'

									+ '<div class="msLocation">' + "N/A" + '</div>'
									+ '</td>'

									+ '<td class="tdGradient" rowspan="2">' + "N/A" + '</td>'

									+ '<td class="msTS1">TS1</td>'
									+ '<td class="msTSE">' + "N/A" + '</td>'
									+ '<td class="msTSE">' + "N/A" + '</td>'
									+ '</tr>'

									+ '<tr>'
									+ '<td class="msTS2">TS2</td>'
									+ '<td class="msTSE">' + "N/A" + '</td>'
									+ '<td class="msTSE">' + "N/A" + '</td>'
									+ '</tr>'
							} else {
									for (let i = 0; i < peersLength; i++) {
										netID = peers[i][0];
										record = peers[i][1];

										ts1rx = record["1"]["TXRX"];
										ts2rx = record["2"]["TXRX"];

										ts1 = ((ts1rx == "") ? "msTS1" : ((ts1rx == "TX") ? "msTSTX" : "msTSRX"));
										ts2 = ((ts2rx == "") ? "msTS2" : ((ts2rx == "TX") ? "msTSTX" : "msTSRX"));

										cnx1 = (ts1rx == "") ? "msTS" : ((ts1rx == "TX") ? "msTSTX" : "msTSRX");
										cnx2 = (ts2rx == "") ? "msTS" : ((ts2rx == "TX") ? "msTSTX" : "msTSRX");

										hardwareType = (record["RX_FREQ"] == "N/A" && record["TX_FREQ"] == "N/A") ? "IP Network" : "Radio";

										content += '<tr>'
											+ '<td rowspan="2">'
											+ '<div class="tooltip">'
											+ '<img class="msflag" src="' + getMasterFlag(2, netID) + '"/>'
											+ '<div class="msCallsign">' + record["CALLSIGN"] + '</div>'
											+ '<span class="msNetID">&nbsp;(Id: ' + netID + ')</span>'
											+ '<span class="tooltiptext">'
											+ '<span style="font: 9pt arial,sans-serif;color:#FFFFFF">'
											+ '&nbsp;&nbsp;&nbsp;<b><font color="yellow">' + hardwareType + '</font></b><br>'
											+ '&nbsp;&nbsp;&nbsp;<b>Type/Slot</b>: ' + record["SLOTS"]
											+ '<br>&nbsp;&nbsp;&nbsp;<b>Soft_Ver</b>: ' + record["SOFTWARE_ID"]
											+ '<br>&nbsp;&nbsp;&nbsp;<b>Hardware</b>: ' + record["PACKAGE_ID"]
											+ '</span></span></div><br>'
											+ '<div class="msLocation">' + record["LOCATION"] + '</div></td>'
											+ '<td class="tdGradient" rowspan="2">' + record["CONNECTED"] + '</td>'
											+ '<td class="' + ts1 + '">TS1</td><td class="' + cnx1 + '">';

										if (record["1"]["SUB"] != "")
											content += '<img class="tgflag mstgflag" src="' + getMasterFlag(1, record["1"]["SUB"]) + '"/>';
										
										content += record["1"]["SUB"] + '</td><td class="' + cnx1 + '">'
										
										if (record["1"]["DEST"] != "")
											content += '<img class="tgflag mstgflag" src="' + getMasterFlag(0, record["1"]["DEST"]) + '"/>';

										content += record["1"]["DEST"] + '</td></tr><tr><td class="' + ts2 + '">TS2</td><td class="' + cnx2 + '">';

										if (record["2"]["SUB"] != "")
											content += '<img class="tgflag mstgflag" src="' + getMasterFlag(1, record["2"]["SUB"]) + '"/>';

										content += record["2"]["SUB"] + '</td><td class="' + cnx2 + '">';

										if (record["2"]["DEST"] != "")
											content += '<img class="tgflag mstgflag" src="' + getMasterFlag(0, record["2"]["DEST"]) + '"/>';

										content += record["2"]["DEST"] + '</td></tr>';
								}
							}
						} catch (error) {
						}
				}

				$(content).appendTo("#masters");
				content = "";
		}
	}

	function checkDeadOnline() {
		try {
			var found = false;
			var trafficLength = traffic.length
			for (let i = 0; i < trafficLength; i++) {
				var record = traffic[i];

				if (record.PACKET == "START") {
					var t = new Date(record.DATE + " " + record.TIME);
					if ((Date.now() - t.getTime()) > 240000) {
						// log("timeout, resetting status to END : " + JSON.stringify(traffic[i]));
						found = true;
						record.PACKET = "END";
					}
				}
			}

			if (found)
				doTraffic(traffic);

		} catch (error) {

		}
	}

	function scrollIntoViewFromId(id) {
		if (hideAllTG) {
			hideAllTG = false;
			$("#insertPoint").show();
		};

		const el = document.getElementById(id);
		if (el != null) {

			const yOffset = -50;
			const y = el.getBoundingClientRect().top + window.pageYOffset + yOffset;

			window.scrollTo({top: y, behavior: 'smooth'});

			// el.scrollIntoView(true);
			el.focus();
		}
	}

	function followUpdUser(dmrid) {
		$("#followup tr").remove();
		var content = "";
		var bgClass = "";

		traffic.forEach(om => {
			if (om.PACKET == "END" && (om.DMRID == dmrid || om.CALLSIGN == dmrid)) {
				if (tghilite.has(om.TGID))
					bgClass = 'tgWhite';
				else
					bgClass = 'tgGreen';

				var delay = (om.DELAY == 0) ? "PTT" : om.DELAY;
				if (om.DELAY == 0)
					bgClass += " darker ";

				var alias = om.ALIAS.replace("/images/flags/", "").replace("/img/flags/", "").replace("<img src=", "<img class='tgflag' src=");

				content += "<tr class='" + bgClass + "'><td class='firstname ellipsis'>" + enhanceNames(om.NAME) 
					+ "</td><td class='tdDate'>" + om.DATE + "</td><td class'tdTime'>" + om.TIME + "</td><td class=''>" 
					+ om.TGID + "</td><td class='alias ellipsis'>" + alias + "</td><td class='delay'>" + delay + "</td></tr>";
			}
		});

		$("#followup").append(content);
		$("#followUpModal").show();
	}

	function followupdmrid() {
		var val = $('#search').val();
		$("#inputModal").hide();
		if (val != "")
			followUpdUser(val.toUpperCase());
	}

	function stats() {
		statistics = [];

		for(let i=0; i<traffic.length; i++) {
			var record = traffic[i];

			if (record.PACKET == "END") {
				var tgid = ""+record.TGID;

				record.DELAY = parseInt(record.DELAY);

				if (record.DELAY > 9999)
						record.DELAY = record.DELAY / 1000;

				// skip hidden tgs
				if (tgfilter.has('' + tgid))
						continue;

				if (statistics[tgid] == null) {
					statistics[tgid] = { "tgid": record.TGID, "cnxCount": 1, "cnxTime": record.DELAY };
				}
				else {
					statistics[tgid]["cnxCount"] = statistics[tgid]["cnxCount"] + 1;
					statistics[tgid]["cnxTime"] = statistics[tgid]["cnxTime"] + record.DELAY;
				}
			}
		}

		for (const tgid of tgorder) {
			// skip hidden tgs
			if (tgfilter.has('' + tgid))
					continue;

			if (statistics[tgid] == null)
				statistics[tgid] = { "tgid": tgid, "cnxCount": 0, "cnxTime": 0 };
		}

		$("#statistics tr").remove();
			var content = "";

			statistics.forEach(stat => {
				cnxTime = parseInt(stat.cnxTime);

				if (cnxTime < 60 )
					delay = cnxTime + " sec";
				else if (cnxTime < 3600)
					delay = parseInt(cnxTime / 60) + " min";
				else
					delay = parseInt(cnxTime / 3600) + " hrs";

				content += "<tr class='"+ (stat.cnxCount == 0 ? "trstatisticsred":"trstatisticsgreen") + "'><td class='tdstattg'>" 
					+ stat.tgid + "</td><td class='tdstatcnt'>" + stat.cnxCount + "</td><td class='tdstatdelay'>" + delay + "</td></tr>";
			});

			$("#statistics").append(content);
			$("#statisticsModal").show();
	}

	function tgshas(record, tgs) {
		var tgslength = tgs.length;
		for (let i = 0; i < tgslength; i++) {
			if (tgs[i].id == record.TGID)
				return i;
		}

		return -1;
	}

	function updateRowCount(record, tgs) {
		var count = 0;
		var tgslength = tgs.length;
		
		for (var i = 0; i < tgslength; i++) {
			if (tgs[i].id == record.TGID) {
				if (!tgs[i].dmrids.has(record.DMRID)) {
					tgs[i].dmrids.add(record.DMRID);
					tgs[i].count = tgs[i].dmrids.size;
					return tgs[i].count;
				}
			}
		}

		return count;
	}

	function getPercentage(tgs, totalrecord, id) {
		var tgslength = tgs.length;
		for (let i = 0; i < tgslength; i++) {
			if (tgs[i].id == id)
				return parseInt(((tgs[i].count / totalrecord) * 100) + 0.5);
		}

		return 0;
	}

	function showEmptyTables() {
			var tgsetting;

			if (mobileDevice) {
					$(".thledate, .thleslot, .thlelog, .thlenetid, .thlemaster").css("display", "none");
					showColumnsDefault = "-+-+++-+--";
			}

			if (last_active_tg) {
				if (mobileDevice || !displayPercent)
					$(".thlepc").css("display", "none");

				$("#lastActive").css("display", "table");
			}

			if ((tgsetting = tgsettings["*"]) != null) {
					showColumnsDefault = mobileDevice ? showColumnsDefault : (tgsetting["show-columns"] == null ? "++++++++++":tgsetting["show-columns"]);
					showEmptyDefault = tgsetting["show-empty"] == null ? tgsetting["show-empty"]: false;
					hideDmridDefault = tgsetting["hide-dmrid"] == null ? tgsetting["hide-dmrid"]: "#";
					showStyleDefault = tgsetting["title-style"] ? tgsetting["title-style"]: "";
					showTitleDefault = tgsetting["title-before"] ? "auto" : ""; // any value ends with ""
			}

			Object.keys(tgsettings).forEach((tgid) => {
				var tgName = "tgId" + tgid;

				if (tgid != "*" && document.getElementById(tgName) == null) {
					tgsetting = tgsettings[tgid];
					
					var showEmpty = tgsetting["show-empty"] ? tgsetting["show-empty"] : showEmptyDefault;

					if (showEmpty == true) {
						var emptyTable = "";
						var showColumns = (mobileDevice ? showColumnsDefault:tgsetting["show-columns"] ? tgsetting["show-columns"] : showColumnsDefault);
						var showStyle = tgsetting["title-style"] ? tgsetting["title-style"] : hideDmridDefault;
						var showTitle = tgsetting["title-before"] ? tgsetting["title-before"] : showTitleDefault;

						if (showTitle != "auto" && showTitle != "") {
							emptyTable = '<div class="titleRow"><div class="titleCell" style="' + showStyle + '">' + showTitle + '<div class="homearrow" onclick="scrollIntoViewFromId(`siteHeader`)">◌</div></div><div class="titlePadding">&nbsp;</div><div class="titleFiller">&nbsp;</div></div>' 
							+ '<table id=tb' + tgName + ' class="entitledTables lastheard tablefixed">';
						}
						else
							emptyTable = '<table id=tb' + tgName + ' class="tgtable tables lastheard tablefixed">';
						
						emptyTable += '<thead id="' + tgName + '" tgid="' + tgid + '" tbodyid=hblink' + tgid + '">' 
						+ '<tr class="headerRow">' 
						+ '<th class="thledate'+ ((showColumns.charAt(0) == "-") ? ' visible"':'"') + '>Date</th>'
						+	'<th class="thletime'+ ((showColumns.charAt(1) == "-") ? ' visible"':'"') + '>Heure</th>'
						+ '<th class="thleslot'+ ((showColumns.charAt(2) == "-") ? ' visible"':'"') + '>Slot</th>' 
						+ '<th class="thletx'+ ((showColumns.charAt(3) == "-") ? ' visible"':'"') + ' colspan=2>TX Connectés</th>'
						+ '<th class="thlename'+ ((showColumns.charAt(4) == "-") ? ' visible"':'"') + '>Name</th>'
						+ '<th class="thletg'+ ((showColumns.charAt(5) == "-") ? ' visible"':'"') + '>TG' + tgid + '</th>' 
						+ '<th class="thlelog'+ ((showColumns.charAt(6) == "-") ? ' visible"':'"') + '><a target="_self" href="loglast.html">LOG+ (Cliquez ICI) </a></th>' 
						+ '<th class="thledelay'+ ((showColumns.charAt(7) == "-") ? ' visible"':'"') + '>TX (s)</th>' 
						+ '<th class="thlenetid'+ ((showColumns.charAt(8) == "-") ? ' visible"':'"') + '>NetID</th>' 
						+ '<th class="thlemaster'+ ((showColumns.charAt(9) == "-") ? ' visible"':'"') + '>Master Infra</th>' 
						+ '</tr>' 
						+ '</thead>' 
						+ '<tbody id="hblink' + tgid + '"></tbody></table>';

						/* insert new table into tg tables area regarding tgorder */
						if (document.getElementById("tg" + tgid + "marker") != null)
							$(emptyTable).insertBefore("#tg" + tgid + "marker");
						else
							$('#insertPoint').append(emptyTable);
					}
				}
		});
	}

	function doLastActiveNew() {
		if (last_active_tg == true) {
			let trafficLength = traffic.length;
			let tgs = [];
			let count = 0;

			for (let i = 0, count = 0; i < trafficLength; i++) {
				var record = traffic[i];
				if (tgshas(record, tgs) == -1)
					tgs.push({ "id": record.TGID, "dmrids": new Set([record.DMRID]), "count": 1 });
				else {
					updateRowCount(record, tgs);
				}
			}

			var totalrecord = 0;

			for(let i=0; i<tgs.length; i++)
					totalrecord += tgs[i].count;

			$("#lastActive tbody tr").remove();

			bgClass = 'tgPurple';

			var globalPercentage = 0;

			// keeps the n first unique items
			lastActive = uniqByKeepFirst(traffic, it => it.TGID);

			let lastActiveLength = Math.min(lastActive.length, last_active_size);

			if (lastActiveLength > 0) {
				var showColumns = showColumnsDefault;

				// added max length last_active_size
				for (let i = 0; i < lastActiveLength; i++) {
					var record = lastActive[i];
					var link = '"tgId' + parseInt(record.TGID) + '"';
					var delay = record.DELAY;
					var callsign = record.CALLSIGN;
					var dmrid = record.DMRID;
					var netid = record.SRC_ID;

					if (delay > 9999)
						delay = parseInt(delay / 1000);
					else 
					if (delay < 2)
						delay = "PTT";

					if (callsign == "")
						callsign = dmrid;

					if (hide_dmrid) {
						for(const dh in hide_dmrid) {
							dhl = dh.trim();
							if (dhl.length > 0 && dmrid.startsWith(dhl)) {
								callsign = "XXXXX";
								dmrid = "0000000";
								netid = "XXXXX";
								break;
							}
						};
					}

					for(let tg in tgsettings) {
						if (tg == record.TGID) {
							var tgsetting = tgsettings[tg];

							if (!mobileDevice && tgsetting["show-columns"] != null)
								showColumns = tgsetting["show-columns"];

							var hideDmrid = tgsetting["hide-dmrid"] != null ? tgsetting["hide-dmrid"]:hideDmridDefault;

							if (hideDmrid != null && hideDmrid != "") {
								var hide_those = hideDmrid.split(",");

								for (const dh of hide_those) {
									var dht = dh.trim();
									if (dht.length > 0 && dmrid.startsWith(dht) && !(parseInt(dmrid) in tgbeacons)) {
										callsign = "XXXXX";
										dmrid = "0000000";
										netid = "XXXXX";
										break;
									}
								};
							}
							break;
						}
					};

					var percentage = parseInt(getPercentage(tgs, totalrecord, record.TGID));
					globalPercentage += percentage;

					var flagUrl = getFlag(record.CALLSIGN, dmrid);
					if (flagUrl == "")
						flagUrl = flag64["shield"]; // "shield.png";

					var alias = record.ALIAS.replace("/images/flags/", "").replace("/img/flags/", "").replace("<img src=", "<img class='tgflag' src=");

					if (alias.indexOf("<img") == -1)
						alias = '<img class="tgflag" src="' + getTgFlag(record.TGID) + '">' + alias;

					content = '<tr class=' + bgClass + '>'
						+ "<td class='tdDate"+ ((showColumns.charAt(0) == '-') ? " visible'":"'") + ">" + record.DATE + "</td>"
						+ "<td class='tdTime"+ ((showColumns.charAt(1) == '-') ? " visible'":"'") + ">" +record.TIME + "</td>"
						+ "<td class='slot"+ ((showColumns.charAt(2) == '-') ? " visible'":"'") + ">" + record.TS + "</td>"

					// they both depend on TX connected
						+ "<td class='callsign ellipsis"+ ((showColumns.charAt(3) == '-') ? " visible'":"'") + "><img class='tgflag' src='" + flagUrl + "'/><a target='_blank' href=https://qrz.com/db/" + callsign + ">" + callsign + "</a></td>"
						+ "<td dmrid=" + record.DMRID + " class='dmrid"+ ((showColumns.charAt(3) == '-') ? " visible'":"'") + ">(" + dmrid + ")</td>";

					if (record.NAME.toUpperCase() == callsign)
						content += "<td class='alink firstname ellipsis"+ ((showColumns.charAt(4) == '-') ? " visible'":"'") + " onclick='followUpdUser(" + dmrid + ")'>" + callsign + "</td>";
					else
						content += "<td class='alink firstname ellipsis"+ ((showColumns.charAt(4) == '-') ? " visible'":"'") + " onclick='followUpdUser(" + dmrid + ")'>" + enhanceNames(record.NAME) + "</td>";

					content += "<td class='talkgroup alink"+ ((showColumns.charAt(5) == '-') ? " visible'":"'") + " onclick='scrollIntoViewFromId(" + link + ")'>" + record.TGID + "</td>";

					if (!mobileDevice && displayPercent)
						content += "<td class='percentage'><div id='p"+record.TGID+"'></div></td>";

					content += "<td class='alias ellipsis clickable" + ((showColumns.charAt(6) == '-') ? " visible'":"'") + " onclick='scrollIntoViewFromId(" + link + ")'>" + alias + "</td>";

					if (record.PACKET == "START")
						content += "<td class='online"+ ((showColumns.charAt(7) == '-') ? " visible'":"'") + ">ONLINE</td>";
					else
						content += "<td class='delay"+ ((showColumns.charAt(7) == '-') ? " visible'":"'") + ">" + ((delay != undefined) ? delay : "") + "</td>";

					content += "<td class='netid"+ ((showColumns.charAt(8) == '-') ? " visible'":"'") + ">" + netid + "</td>"
						+ "<td class='infra ellipsis"+ ((showColumns.charAt(9) == '-') ? " visible'":"'") + ">" + record.SYS + "</td>"
						+ "</tr>";

					$("#lastActiveBody").append(content);

					var elem = document.getElementById("p"+record.TGID);
					
					if (elem != null) {
						var knob = pureknob.createKnob(23, 23);
						knob.setProperty('angleStart', -0.75 * Math.PI);
						knob.setProperty('angleEnd', 0.75 * Math.PI);
						knob.setProperty('colorFG', '#e52713');
						knob.setProperty('colorBG', '#6cc43c');
						knob.setProperty('trackWidth', 0.3);
						knob.setProperty('readonly', true);
						knob.setProperty('label', null);
						knob.setProperty('textScale', 2.5);
						knob.setProperty('valMin', 0);
						knob.setProperty('valMax', 100);

						knob.setValue(percentage);
						elem.appendChild(knob.node());
					}
				}
			}
		}
	}

	function doTraffic(t) {
		if (t != null) {
			if (Array.isArray(t))
				traffic = t;
			else
				traffic.unshift(t);

			let trafficLength = traffic.length;

			if (trafficLength > 0) {
				checkDeadOnline();

				// keeps the n first unique items
				// traffic = uniqByKeepFirst(traffic, it => it.DMRID);

				var content = "";

				cleaned = true;
				$(".lastheard tbody tr").remove();

				for (var i = 0; i < trafficLength; i++) {
					var record = traffic[i];
					var tgid = parseInt(record.TGID);

					// skip excluded TG
					if (tgfilter.has('' + tgid))
						continue;

					// add dynamic allowed tgid
					if (!tgorder.has('' + tgid)) {
						if (dynamic_tg == true)
							tgorder.add(tgid);
						else
							continue;
					}

					var tgName = "tgId" + tgid;

					if (tghilite.has(record.TGID))
						bgClass = 'tgWhite';
					else
						bgClass = 'tgGreen';

					var showColumns = showColumnsDefault;
					var hideDmrid = hideDmridDefault;

					var alias = record.ALIAS.replace("/images/flags/", "").replace("/img/flags/", "").replace("<img src=", "<img class='tgflag' src=");

					/* check if table already exists */
					if (document.getElementById(tgName) == null) {

						var showStyle = showStyleDefault;
						var showTitle = showTitleDefault;

						/* build the missing table */
						var emptyTable = '<table id=tb' + tgName + ' class="tgtable tables lastheard tablefixed">';

						for(const tg in tgsettings) {
							if (tg == "*" || record.TGID == tg) {

								var tgsetting = tgsettings[tg];

								if (!mobileDevice && tgsetting["show-columns"])
									showColumns = tgsetting["show-columns"];

								showStyle = tgsetting["title-style"] ? tgsetting["title-style"]:showStyleDefault;
								showTitle = tgsetting["title-before"] ? ((tgsetting["title-before"] == "auto" || tgsetting["title-before"] == "") ? alias : tgsetting["title-before"]) : alias;

								if (showTitle) {
									emptyTable = '<div class="titleRow"><div class="titleCell" style="' + showStyle + '">' + showTitle + '<div class="homearrow" onclick="scrollIntoViewFromId(`siteHeader`)">◌</div></div><div class="titlePadding">&nbsp;</div><div class="titleFiller">&nbsp;</div></div>' 
															+ '<table id=tb' + tgName + ' class="entitledTables lastheard tablefixed">';
								}
								else
									emptyTable = '<table id=tb' + tgName + ' class="tgtable tables lastheard tablefixed">';
								break;
							}
						};

						emptyTable += '<thead id="' + tgName + '" tgid="' + tgid + '" tbodyid=hblink' + tgid + '">' 
							+ '<tr class="headerRow">' 
							+ '<th class="thledate'+ ((showColumns.charAt(0) == "-") ? ' visible"':'"') + '>Date</th>' 
							+ '<th class="thletime'+ ((showColumns.charAt(1) == "-") ? ' visible"':'"') + '>Heure</th>' 
							+ '<th class="thleslot'+ ((showColumns.charAt(2) == "-") ? ' visible"':'"') + '>Slot</th>' 
							+ '<th class="thletx'+ ((showColumns.charAt(3) == "-") ? ' visible"':'"') + ' colspan=2>TX Connectés</th>' 
							+ '<th class="thlename'+ ((showColumns.charAt(4) == "-") ? ' visible"':'"') + '>Name</th>' 
							+ '<th class="thletg'+ ((showColumns.charAt(5) == "-") ? ' visible"':'"') + '>TG' + tgid + '</th>' 
							+ '<th class="thlelog'+ ((showColumns.charAt(6) == "-") ? ' visible"':'"') + '><a target="_self" href="loglast.html">LOG+ (Cliquez ICI) </a></th>' 
							+ '<th class="thledelay'+ ((showColumns.charAt(7) == "-") ? ' visible"':'"') + '>TX (s)</th>' 
							+ '<th class="thlenetid'+ ((showColumns.charAt(8) == "-") ? ' visible"':'"') + '>NetID</th>' 
							+ '<th class="thlemaster'+ ((showColumns.charAt(9) == "-") ? ' visible"':'"') + '>Master Infra</th>' 
							+ '</tr>' 
							+ '</thead>' 
							+ '<tbody id="hblink' + tgid + '"></tbody></table>';

						/* insert new table into tg tables area regarding tgorder */
						if (document.getElementById("tg" + tgid + "marker") != null)
							$(emptyTable).insertBefore("#tg" + tgid + "marker");
						else
							$('#insertPoint').append(emptyTable);
					}

					if (last_active_tg == true && i == 0 && lastActiveTG != tgid) {
						lastActiveTG = tgid;
						$('.headerRow').removeClass("lastActiveTG");
						$("#" + tgName).children(".headerRow").addClass("lastActiveTG")
					}

					var callsign = record.CALLSIGN;
					var dmrid = record.DMRID;
					var delay = record.DELAY;
					var netid = record.SRC_ID;

					if (delay > 9999)
						delay = parseInt(delay / 1000);
					else if (delay < 2)
						delay = "PTT";

					if (hide_dmrid) {
						for(const dh in hide_dmrid) {
							dhl = dh.trim();
							if (dhl.length > 0 && dmrid.startsWith(dhl)) {
								callsign = "XXXXX";
								dmrid = "0000000";
								netid = "XXXXX";
								break;
							}
						};
					}

					for(let tg in tgsettings) {
						if (tg == record.TGID) {
							var tgsetting = tgsettings[tg];

							if (!mobileDevice && tgsetting["show-columns"] != null)
								showColumns = tgsetting["show-columns"];

							var hideDmrid = tgsetting["hide-dmrid"] ? tgsetting["hide-dmrid"]:hideDmridDefault;
							if (hideDmrid != null && hideDmrid != "") {
								var hide_those = hideDmrid.split(",");

								for (const dh of hide_those) {
									var dht = dh.trim();
									if (dht.length > 0 && dmrid.startsWith(dht) && !(parseInt(dmrid) in tgbeacons)) {
										callsign = "XXXXX";
										dmrid = "0000000";
										netid = "XXXXX";
										break;
									}
								};
							}

							break;
						}
					};

					if (callsign == "")
						callsign = dmrid;

					if ($('#hblink' + record.TGID + ' >tr td[dmrid=' + record.DMRID + ']').length == 0) {
						/* deal with content if < displaylines */
						if ($('#tb' + tgName + ' >tbody >tr').length < displayLines) {
							var flagUrl = getFlag(record.CALLSIGN, record.DMRID);
							if (flagUrl == "")
								flagUrl = flag64["shield"]; // "shield.png";

								content = '<tr class=' + bgClass + '>'
									+ "<td class='tdDate"+ ((showColumns.charAt(0) == '-') ? " visible'":"'") + ">" + record.DATE + "</td>"
									+ "<td class='tdTime"+ ((showColumns.charAt(1) == '-') ? " visible'":"'") + ">" +record.TIME + "</td>"
									+ "<td class='slot"+ ((showColumns.charAt(2) == '-') ? " visible'":"'") + ">" + record.TS + "</td>"

								// they both depend on TX connected
									+ "<td class='callsign ellipsis"+ ((showColumns.charAt(3) == '-') ? " visible'":"'") + "><img class='tgflag' src='" + flagUrl + "'/><a target='_blank' href=https://qrz.com/db/" + callsign + ">" + callsign + "</a></td>"
									+ "<td dmrid=" + record.DMRID + " class='dmrid"+ ((showColumns.charAt(3) == '-') ? " visible'":"'") + ">(" + dmrid + ")</td>";

								if (record.NAME.toUpperCase() == callsign)
									content += "<td class='alink firstname ellipsis"+ ((showColumns.charAt(4) == '-') ? " visible'":"'") + " onclick='followUpdUser(" + record.DMRID + ")'>" + callsign + "</td>";
								else
									content += "<td class='alink firstname ellipsis"+ ((showColumns.charAt(4) == '-') ? " visible'":"'") + " onclick='followUpdUser(" + record.DMRID + ")'>" + enhanceNames(record.NAME) + "</td>";

								content += "<td class='talkgroup"+ ((showColumns.charAt(5) == '-') ? " visible'":"'") + ">" + tgid + "</td>"
									+ "<td class='alias ellipsis"+ ((showColumns.charAt(6) == '-') ? " visible'":"'") + ">" + alias + "</td>";

								if (record.PACKET == "START")
									content += "<td class='online"+ ((showColumns.charAt(7) == '-') ? " visible'":"'") + ">ONLINE</td>";
								else
									content += "<td class='delay"+ ((showColumns.charAt(7) == '-') ? " visible'":"'") + ">" + ((delay != undefined) ? delay : "") + "</td>";

								content += "<td class='netid"+ ((showColumns.charAt(8) == '-') ? " visible'":"'") + ">" + netid + "</td>"
									+ "<td class='infra ellipsis"+ ((showColumns.charAt(9) == '-') ? " visible'":"'") + ">" + record.SYS + "</td>"
									+ "</tr>";

							$("#hblink" + tgid).append(content);
						}
					}
				}
			}

			doLastActiveNew();
		}
	}

	function log(msg) {
		console.log(msg);
	};

	function treatTables(CTable, emaster) {
		if (CTable != null) {
			updateOpenBridges(CTable["OPENBRIDGES"]);
			updateMasters(CTable["MASTERS"], emaster);
			updatePeers(CTable["PEERS"]);
		}
	}

	$(document).ready(function () {
		$(window).click(function (event) {
			if (event.target == document.getElementById("listenersModal"))
				$("#listenersModal").hide();
		});

		$(window).click(function (event) {
			if (event.target == document.getElementById("statisticsModal"))
				$("#statisticsModal").hide();
		});

		$(document).on("click", "#lastActive thead", function () {
			if (hideAllTG = !hideAllTG)
				$("#insertPoint").hide();
			else
				$("#insertPoint").show();

			saveSettings();
		});

		$(document).on("click", ".lastheard thead", function () {
			var hblink = "#hblink" + $(this).attr('tgid');
			$(hblink).toggle(100);

			setTimeout(() => {
				var display = $(hblink).css('display');
				if (display == "none")
					$("#tbtgId" + $(this).attr('tgid')).css("filter", "blur(1px)");
				else
					$("#tbtgId" + $(this).attr('tgid')).css("filter", "blur(0)");

				saveSettings();
			}, 125);
		});

		$(document).on("click", ".network thead", function () {
			$("#" + $(this).attr('tbodyid')).toggle(100, () => {
    		saveSettings();
  		});
		});

		$(document).on("click", ".close", function () {
			$("#statisticsModal").hide();
			$("#listenersModal").hide();
			$("#followUpModal").hide();
		});

		$(document).on("dblclick", "#btnlisteners", function (e) {
			if (e.ctrlKey) {
				$("#listeners tr").remove();
				var content = "";

				listenerList = uniqByKeepLast(listenerList, swl => swl.NETID);

				listenerList.forEach(swl => {
					content += "<tr class='trlisteners'><td>" + swl.CALLSIGN + "</td><td>" + swl.IP + "</td><td>" + swl.PORT + "</td><td>" + swl.NETID + "</td></tr>";
				});

				$("#listeners").append(content);
				$("#listenersModal").show();
			}
		});

		document.getElementById("search").addEventListener('keyup', (event) => {
  		const keyName = event.key;
			// As the user releases the Ctrl key, the key is no longer active,
			// so event.ctrlKey is false.
			if (keyName === 'Escape')
				document.getElementById("inputModal").style.display = 'none';
		}, false);
	});

	window.onload = () => {
		doApplyConfig = true;
		lastActive = [];
		listeners = 0;
		lastActiveTG = 0;
		mobileDevice = "<<<MOBILE>>>" == "True";

		showColumnsDefault = "";
		hideDmridDefault = "";
		showTitleDefault = "";
		showStyleDefault = "";
		showEmptyDefault = false;

		if (mobileDevice)	{
			var r = document.querySelector(':root');
			r.style.setProperty('--table-width', '100%');
			r.style.setProperty('--color-fz-html', '20pt');

			$("#sysoptables").css("display", "none");
			$("#footer, #infoLine").css("font-size", "0.4rem");
		}

		var wsuri = "ws://" + window.location.hostname + ":<<<SOCKET_SERVER_PORT>>>?page=dashboard";

		if (getConfigFromLocalStorage != null)
			getConfigFromLocalStorage();

		if (isNaN(displayLines))
			displayLines = 10;

		tgorder.forEach(tgid => {
			if (!tgfilter.has('' + tgid))
				$("#insertPoint").append($("<div id='tg" + tgid + "marker'></div>"));
		});

		function WSConnection() {
			'use strict';
			this.socket = {};
		}

		WSConnection.prototype.connect = (url) => {
			'use strict';

			return new Promise((resolve, reject) => {
				if ("WebSocket" in window)
					this.socket = new WebSocket(url);
				else if ("MozWebSocket" in window)
					this.socket = new MozWebSocket(url);
				else {
					log("Browser does not support WebSocket!");
					resolve();
				}

				this.socket.onopen = () => {
					log("Connected to " + url)
					resolve();
				};

				this.socket.onmessage = (e) => {
					var data = null;

					try {
						data = JSON.parse(e.data);

						// console.log("");
						// console.log(data);
						// console.log("");

						if (data != null) {
							checkDeadOnline();

							if (data.BIGEARS)
								$("#btnlisteners").text("\uD83D\uDD75 SWL " + data.BIGEARS);

							if (data.LISTENERS)
								listenerList = data.LISTENERS;

							// FIRST PACKET IS CONFIG
							if (data.CONFIG) {
								// if (data.CONFIG.USERS)
								//     subscribers = data.CONFIG.USERS.results;

								if (data.CONFIG.BIGEARS) {
									$("#btnlisteners").text("\uD83D\uDD75 SWL " + data.CONFIG.BIGEARS);
								}

								if (data.CONFIG.PACKETS) {
									// will be done only once
									showEmptyTables();

									doTraffic(data.CONFIG.PACKETS.TRAFFIC);
								}

								if (data.CONFIG.LISTENERS)
									listenerList = data.CONFIG.LISTENERS;
							} else {
								if (!mobileDevice) {
									if (data.CTABLE)
										treatTables(data.CTABLE, data.EMPTY_MASTERS);

									if (data.BRIDGES)
										updateBridges(data.BRIDGES);
								}

								if (data.TRAFFIC)
									doTraffic(data.TRAFFIC);

								// if (data.BTABLE)
								// 	log(JSON.stringify(data.BTABLE));

								// if (data.STATUS)
								// 	log(data.STATUS);
							}

							if (themeSettings == "auto")
								adjustTheme();

							if (doApplyConfig) {
								doApplyConfig = false;
								applyConfig();
							}
					}
					} catch (error) {
						log(error);
					}
				};

				socket.onerror = function (error) {
					console.log('WebSocket error: ' + error);
					reject(error);
				};

				socket.onclose = function (e) {
					log("Connection closed (wasClean = " + e.wasClean + ", code = " + e.code + ", reason = '" + e
						.reason + "')");
					this.sock = null;
				};
			});
		};

		WSConnection.prototype.disconnect = () => {
			'use strict';
			console.log("Disconnect request from local app layer");
			this.socket.close();
		};


		setTimeout(() => {
			socket = new WSConnection().connect(wsuri);
		}, 250);
	};

	window.onunload = () => {
		socket = null;
	}
</script>

</html>
